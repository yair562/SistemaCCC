<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registrar Entrada de Producto</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/entradas.css') }}">
</head>
<body>
    <h1>Registrar Entrada</h1>

    {% if error %}
    <div style="background:#ffd6d6;border:1px solid #ff9c9c;padding:10px;border-radius:6px;margin-bottom:10px;color:#800">
        {{ error }}
    </div>
    {% endif %}

    <a href="{{ url_for('admin') }}" class="btn-back">ðŸ”™ Volver al panel</a>

    <!-- SECCIÃ“N DE CONFIGURACIÃ“N DE CAMPOS A MANTENER -->
    <div class="mantener-campos-header">
        <h3>ðŸ”§ Configurar campos a mantener</h3>
        <div class="toggle-buttons">
            <button type="button" id="btnMantenerTodo" class="btn-toggle">âœ… Mantener todo</button>
            <button type="button" id="btnLimpiarTodo" class="btn-toggle">ðŸ”„ Limpiar todo</button>
        </div>
    </div>

    <form id="entradaForm" method="post" action="{{ url_for('entradas_register') }}">
        <!-- Campo oculto para enviar campos mantenidos al backend -->
        <input type="hidden" id="campos_mantenidos" name="campos_mantenidos" value="">
        
        <div class="grid">
            <!-- IZQUIERDA -->
            <div>
                <div class="form-row">
                    <label for="prefijo">Prefijo SKU (elige existente o escribe uno nuevo)</label>
                    <div class="input-inline">
                        <input id="prefijo" name="prefijo" list="prefijos_list"
                            placeholder="Escribe o elige un prefijo"
                            value="{{ prefijo_mantener if prefijo_mantener else '' }}">
                        <datalist id="prefijos_list">
                            {% for p in prefixes %}
                            <option value="{{ p }}">{{ p }}</option>
                            {% endfor %}
                        </datalist>
                    </div>
                </div>
                
                <div class="form-row">
                    <label for="sku">SKU (se autogenera)</label>
                    <div style="display:flex; gap:8px; align-items:center">
                        <input id="sku" name="sku" type="text" readonly placeholder="Prefijo-123" value="">
                        <button id="genSku" type="button">Generar siguiente SKU</button>
                        <select id="existingSkus" style="margin-left:8px;padding:8px;border-radius:8px">
                            <option value="">-- SKUs existentes --</option>
                        </select>
                        <span id="selSkuTipo" style="margin-left:8px;color:var(--muted);font-weight:600"></span>
                    </div>
                </div>

                <div class="form-row">
                    <label for="tipo">
                        Tipo 
                        <span class="toggle-field" data-field="tipo">
                            <button type="button" class="btn-mantener btn-mantener-off" data-field="tipo">âš¡ Mantener</button>
                        </span>
                    </label>
                    <input id="tipo" name="tipo" list="tipo_list" value="{{ tipo_mantener if tipo_mantener else '' }}">
                    <datalist id="tipo_list"></datalist>
                </div>

                <div class="form-row">
                    <label for="marca">
                        Marca
                        <span class="toggle-field" data-field="marca">
                            <button type="button" class="btn-mantener btn-mantener-off" data-field="marca">âš¡ Mantener</button>
                        </span>
                    </label>
                    <input id="marca" name="marca" list="marca_list" value="{{ marca_mantener if marca_mantener else '' }}">
                    <datalist id="marca_list"></datalist>
                </div>

                <div class="form-row">
                    <label for="modelo">
                        Modelo
                        <span class="toggle-field" data-field="modelo">
                            <button type="button" class="btn-mantener btn-mantener-off" data-field="modelo">âš¡ Mantener</button>
                        </span>
                    </label>
                    <input id="modelo" name="modelo" list="modelo_list" value="{{ modelo_mantener if modelo_mantener else '' }}">
                    <datalist id="modelo_list"></datalist>
                </div>
            </div>

            <!-- DERECHA -->
            <div>
                <div class="form-row">
                    <label for="no_serie">No. Serie (scanner o teclado)</label>
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
                        <input id="no_serie" name="no_serie" type="text" placeholder="Escanea o escribe el no. serie" value="">
                        <button id="focusNoSerie" type="button">ðŸŽ¯ Scan</button>
                        <button id="startServerScan" type="button" style="margin-left:8px">Iniciar scanner (servidor)</button>
                        <button id="stopServerScan" type="button" style="margin-left:6px">Detener scanner</button>
                        <span id="scannerStatus" style="margin-left:8px; font-weight:600; color:#333">Inactivo</span>
                    </div>
                </div>

                <div class="form-row">
                    <label for="precio">
                        Precio
                        <span class="toggle-field" data-field="precio">
                            <button type="button" class="btn-mantener btn-mantener-off" data-field="precio">âš¡ Mantener</button>
                        </span>
                    </label>
                    <input id="precio" name="precio" type="text" value="{{ precio_mantener if precio_mantener else '' }}">
                </div>

                <div class="form-row">
                    <label for="estado">
                        Estado
                        <span class="toggle-field" data-field="estado">
                            <button type="button" class="btn-mantener btn-mantener-off" data-field="estado">âš¡ Mantener</button>
                        </span>
                    </label>
                    <input id="estado" name="estado" list="estado_list" value="{{ estado_mantener if estado_mantener else '' }}">
                    <datalist id="estado_list"></datalist>
                </div>

                <div class="form-row">
                    <label for="ubicacion">
                        UbicaciÃ³n
                        <span class="toggle-field" data-field="ubicacion">
                            <button type="button" class="btn-mantener btn-mantener-off" data-field="ubicacion">âš¡ Mantener</button>
                        </span>
                    </label>
                    <input id="ubicacion" name="ubicacion" list="ubicacion_list" value="{{ ubicacion_mantener if ubicacion_mantener else '' }}">
                    <datalist id="ubicacion_list"></datalist>
                </div>
            </div>
        </div>

        <div class="form-row">
            <label for="observacion">
                ObservaciÃ³n
                <span class="toggle-field" data-field="observacion">
                    <button type="button" class="btn-mantener btn-mantener-off" data-field="observacion">âš¡ Mantener</button>
                </span>
            </label>
            <textarea id="observacion" name="observacion" rows="3">{{ observacion_mantener if observacion_mantener else '' }}</textarea>
        </div>

        <div class="actions">
            <button type="submit">Registrar entrada</button>
        </div>
    </form>

    <!-- ... (el resto del JavaScript se mantiene igual) ... -->

    <!-- ========================================================= -->
    <!-- ======================   SCRIPTS   ======================= -->
    <!-- ========================================================= -->
    <script>
        // ============================================================
        // ========== SISTEMA DE MANTENER CAMPOS MEJORADO ==========
        // ============================================================

        class MantenerCampos {
    constructor() {
        this.camposAMantener = new Set();
        this.valoresMantenidos = {}; // NUEVO: Guarda los valores de los campos
        this.init();
    }

    init() {
        this.cargarEstado();
        this.configurarEventListeners();
        this.actualizarEstilos();
        this.aplicarValoresMantenidos(); // NUEVO: Aplicar valores guardados
        
        console.log('ðŸ”§ Sistema de mantener campos iniciado. Campos activos:', Array.from(this.camposAMantener));
        console.log('ðŸ“‹ Valores mantenidos:', this.valoresMantenidos);
    }

    configurarEventListeners() {
        document.querySelectorAll('.btn-mantener').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const campo = e.target.dataset.field;
                this.toggleCampo(campo);
            });
        });

        document.getElementById('btnMantenerTodo')?.addEventListener('click', () => {
            this.mantenerTodos();
        });

        document.getElementById('btnLimpiarTodo')?.addEventListener('click', () => {
            this.limpiarTodos();
        });

        // NUEVO: Guardar valores cuando cambien los inputs
        document.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', (e) => {
                const campo = e.target.id;
                if (this.camposAMantener.has(campo)) {
                    this.guardarValorCampo(campo, e.target.value);
                }
            });

            input.addEventListener('change', (e) => {
                const campo = e.target.id;
                if (this.camposAMantener.has(campo)) {
                    this.guardarValorCampo(campo, e.target.value);
                }
            });
        });
    }

    // NUEVO: Guardar valor de un campo especÃ­fico
    guardarValorCampo(campo, valor) {
        this.valoresMantenidos[campo] = valor;
        this.guardarEstado();
        console.log(`ðŸ’¾ Guardado valor para ${campo}:`, valor);
    }

    toggleCampo(campo) {
        if (this.camposAMantener.has(campo)) {
            this.camposAMantener.delete(campo);
            // Eliminar el valor guardado cuando se deja de mantener
            delete this.valoresMantenidos[campo];
            console.log(`âŒ Dejando de mantener: ${campo}`);
        } else {
            this.camposAMantener.add(campo);
            // Guardar el valor actual cuando se activa mantener
            const input = document.getElementById(campo);
            if (input && input.value) {
                this.valoresMantenidos[campo] = input.value;
            }
            console.log(`âœ… Manteniendo campo: ${campo}`);
        }
        this.actualizarEstilos();
        this.guardarEstado();
    }

    mantenerTodos() {
        const campos = ['tipo', 'marca', 'modelo', 'precio', 'estado', 'ubicacion', 'observacion'];
        campos.forEach(campo => {
            this.camposAMantener.add(campo);
            // Guardar valores actuales cuando se activa "mantener todo"
            const input = document.getElementById(campo);
            if (input && input.value) {
                this.valoresMantenidos[campo] = input.value;
            }
        });
        console.log('âœ… Activado: Mantener todos los campos');
        this.actualizarEstilos();
        this.guardarEstado();
    }

    limpiarTodos() {
        this.camposAMantener.clear();
        this.valoresMantenidos = {};
        console.log('ðŸ”„ Desactivado: Limpiar todos los campos');
        this.actualizarEstilos();
        this.guardarEstado();
    }

    actualizarEstilos() {
        document.querySelectorAll('.btn-mantener').forEach(btn => {
            const campo = btn.dataset.field;
            if (this.camposAMantener.has(campo)) {
                btn.classList.remove('btn-mantener-off');
                btn.classList.add('btn-mantener-on');
                btn.textContent = 'âœ… Manteniendo';
            } else {
                btn.classList.remove('btn-mantener-on');
                btn.classList.add('btn-mantener-off');
                btn.textContent = 'âš¡ Mantener';
            }
        });

        document.querySelectorAll('input, textarea').forEach(input => {
            const campo = input.id;
            if (this.camposAMantener.has(campo)) {
                input.classList.add('campo-mantenido');
            } else {
                input.classList.remove('campo-mantenido');
            }
        });
    }

    // NUEVO: Aplicar valores guardados a los campos
    aplicarValoresMantenidos() {
        Object.keys(this.valoresMantenidos).forEach(campo => {
            const input = document.getElementById(campo);
            if (input && this.valoresMantenidos[campo]) {
                input.value = this.valoresMantenidos[campo];
                console.log(`ðŸ”„ Aplicando valor mantenido para ${campo}:`, this.valoresMantenidos[campo]);
            }
        });
    }

    guardarEstado() {
        const estado = {
            campos: Array.from(this.camposAMantener),
            valores: this.valoresMantenidos
        };
        localStorage.setItem('mantenerCampos', JSON.stringify(estado));
    }

    cargarEstado() {
        try {
            const guardado = localStorage.getItem('mantenerCampos');
            if (guardado) {
                const estado = JSON.parse(guardado);
                this.camposAMantener = new Set(estado.campos || []);
                this.valoresMantenidos = estado.valores || {};
                console.log('ðŸ“‚ Estado cargado desde localStorage:', estado);
            } else {
                console.log('ðŸ“‚ No hay estado guardado en localStorage');
            }
        } catch (e) {
            console.log('âŒ No se pudo cargar estado guardado:', e);
        }
    }

    resetearFormulario() {
        // SOLO limpiar campos que NO estÃ¡n marcados para mantener
        const campos = ['tipo', 'marca', 'modelo', 'precio', 'estado', 'ubicacion', 'observacion'];
        
        campos.forEach(campo => {
            if (!this.camposAMantener.has(campo)) {
                const input = document.getElementById(campo);
                if (input) {
                    input.value = '';
                }
            }
        });

        // Siempre limpiar el nÃºmero de serie
        const noSerieInput = document.getElementById('no_serie');
        if (noSerieInput) {
            noSerieInput.value = '';
        }

        console.log('ðŸ”„ Formulario reseteado. Campos mantenidos:', Array.from(this.camposAMantener));
    }

    limpiarTodosLosCampos() {
        // SOLO limpiar campos que NO estÃ¡n marcados para mantener
        const camposALimpiar = ['tipo', 'marca', 'modelo', 'no_serie', 'precio', 'estado', 'ubicacion', 'observacion'];
        
        camposALimpiar.forEach(campo => {
            if (!this.camposAMantener.has(campo) || campo === 'no_serie') {
                const input = document.getElementById(campo);
                if (input) {
                    input.value = '';
                }
            }
        });
    }
}

        let mantenerCamposSystem;

        // ============================================================
        // ========== FUNCIONES DEL FORMULARIO Y ESCÃNER ==========
        // ============================================================

        // Helper to fetch JSON
        async function getJSON(url){
            const r = await fetch(url);
            if(!r.ok) throw new Error('HTTP '+r.status);
            return r.json();
        }

        const prefijoEl = document.getElementById('prefijo');
        const skuEl = document.getElementById('sku');
        const genBtn = document.getElementById('genSku');
        const focusNo = document.getElementById('focusNoSerie');
        const noSerie = document.getElementById('no_serie');

        async function loadOptionsFor(pref){
            if(!pref) return;
            try{
                const j = await getJSON('/entradas/options?prefijo=' + encodeURIComponent(pref));
                if(j.ok){
                    const data = j.data;
                    // fill datalists
                    for(const k of ['tipo','marca','modelo','estado','ubicacion']){
                        const listId = k + '_list';
                        const list = document.getElementById(listId);
                        if(!list) continue;
                        list.innerHTML = '';
                        (data[k]||[]).forEach(v=>{
                            const opt = document.createElement('option'); opt.value = v; list.appendChild(opt);
                        });
                    }
                }
            }catch(e){
                console.warn('options error', e);
            }
        }

        async function genNextSKU(pref){
            if(!pref) return;
            try{
                const j = await getJSON('/entradas/next_sku?prefijo=' + encodeURIComponent(pref));
                if(j.ok){
                    skuEl.value = j.next_sku;
                }
            }catch(e){ console.warn(e); }
        }

        if(prefijoEl){
            // use input event so typing also triggers option load when user stops typing
            let prefijoTimer = null;
            prefijoEl.addEventListener('input', async function(){
                const v = this.value.trim();
                if(!v) return;
                // debounce
                if(prefijoTimer) clearTimeout(prefijoTimer);
                prefijoTimer = setTimeout(async ()=>{
                    await genNextSKU(v);
                    await loadOptionsFor(v);
                    // load existing SKUs for this prefix
                    try{
                        const r = await getJSON('/entradas/skus?prefijo=' + encodeURIComponent(v));
                        if(r.ok){
                            const sel = document.getElementById('existingSkus');
                            sel.innerHTML = '<option value="">-- SKUs existentes --</option>';
                            (r.data||[]).forEach(item=>{
                                const opt = document.createElement('option');
                                opt.value = item.sku;
                                opt.dataset.tipo = item.tipo || '';
                                opt.text = item.sku + ' â€” ' + (item.tipo || '');
                                sel.appendChild(opt);
                            });
                        }
                    }catch(e){/*ignore*/}
                }, 300);
            });
        }

        if(genBtn){
            genBtn.addEventListener('click', async ()=>{
                const v = prefijoEl.value || '';
                if(!v){ alert('Selecciona o escribe un prefijo primero'); return; }
                await genNextSKU(v);
            });
        }

        // when selecting an existing sku, show tipo and fetch its details and prefill
        const existingSkus = document.getElementById('existingSkus');
        const selSkuTipo = document.getElementById('selSkuTipo');
        if(existingSkus){
            existingSkus.addEventListener('change', async function(){
                const sku = this.value;
                const selOpt = this.options[this.selectedIndex];
                if(selSkuTipo) selSkuTipo.textContent = (selOpt && selOpt.dataset) ? (selOpt.dataset.tipo || '') : '';
                if(!sku) return;
                try{
                    const r = await getJSON('/product_by_sku?sku=' + encodeURIComponent(sku));
                    if(r.ok && r.data){
                        skuEl.value = r.data.sku || sku;
                        document.getElementById('tipo').value = r.data.tipo || '';
                        document.getElementById('marca').value = r.data.marca || '';
                        document.getElementById('modelo').value = r.data.modelo || '';
                        document.getElementById('no_serie').value = r.data.no_serie || '';
                        document.getElementById('precio').value = r.data.precio || '';
                        document.getElementById('estado').value = r.data.estado || '';
                        document.getElementById('ubicacion').value = r.data.ubicacion || '';
                    }
                }catch(e){/*ignore*/}
            });
        }

        if(focusNo){
            focusNo.addEventListener('click', ()=>{ noSerie.focus(); noSerie.select(); });
        }

        // ============================================================
        // ========== SISTEMA DE ESCÃNER DEL SERVIDOR ==========
        // ============================================================

        // Server scanner integration: poll /last_scanned and set no_serie
        let serverScanActive = false; // indicates whether we expect server scanning
        let pollInterval = null;

        async function startServerScanner(){
            try{
                const r = await fetch('/start_scanner');
                const j = await r.json();
                if(r.ok && j.ok){
                    serverScanActive = true;
                    scannerStatus.textContent = 'Activo â€” ' + (j.msg || 'escaneando');
                    scannerStatus.style.color = 'green';
                    startPolling();
                } else {
                    scannerStatus.textContent = 'Error: ' + (j.msg || r.status);
                    scannerStatus.style.color = 'crimson';
                }
            }catch(e){
                scannerStatus.textContent = 'Error: ' + e.message;
                scannerStatus.style.color = 'crimson';
            }
        }

        async function stopServerScanner(){
            try{
                const r = await fetch('/stop_scanner');
                const j = await r.json();
                serverScanActive = false;
                scannerStatus.textContent = (j && j.msg) ? j.msg : 'Detenido';
                scannerStatus.style.color = '#333';
                stopPolling();
            }catch(e){
                scannerStatus.textContent = 'Error: ' + e.message;
                scannerStatus.style.color = 'crimson';
            }
        }

        function startPolling(){
            if(pollInterval) return;
            pollInterval = setInterval(async ()=>{
                if(!serverScanActive) return;
                try{
                    const r = await fetch('/last_scanned');
                    if(!r.ok) return;
                    const j = await r.json();
                    if(j && j.code){
                        // fill no_serie and prefill fields if product exists
                        noSerie.value = j.code;
                        try{
                            const p = await fetch('/product_by_serial?no=' + encodeURIComponent(j.code));
                            if(p.ok){
                                const pj = await p.json();
                                if(pj.ok && pj.data){
                                    document.getElementById('marca').value = pj.data.marca || '';
                                    document.getElementById('modelo').value = pj.data.modelo || '';
                                    document.getElementById('tipo').value = pj.data.tipo || '';
                                    document.getElementById('ubicacion').value = pj.data.ubicacion || '';
                                    // also generate SKU if prefijo selected
                                    const pref = prefijoEl.value;
                                    if(pref) genNextSKU(pref);
                                }
                            }
                        }catch(e){}
                    }
                }catch(e){ }
            }, 700);
        }

        function stopPolling(){ if(pollInterval){ clearInterval(pollInterval); pollInterval=null; } }

        // Hook up start/stop buttons
        const startBtn = document.getElementById('startServerScan');
        const stopBtn = document.getElementById('stopServerScan');
        const scannerStatus = document.getElementById('scannerStatus');
        if(startBtn) startBtn.addEventListener('click', startServerScanner);
        if(stopBtn) stopBtn.addEventListener('click', stopServerScanner);

// ============================================================
// ========== INICIALIZACIÃ“N ==========
// ============================================================

document.addEventListener('DOMContentLoaded', function() {
    mantenerCamposSystem = new MantenerCampos();
    
    // Configurar valores desde el backend (solo el prefijo se mantiene automÃ¡ticamente)
    const prefijoMantener = "{{ prefijo_mantener }}";
    if (prefijoMantener && prefijoMantener.trim() !== '') {
        console.log("ðŸ”„ Configurando formulario con prefijo del backend:", prefijoMantener);
        
        setTimeout(async () => {
            await genNextSKU(prefijoMantener);
            await loadOptionsFor(prefijoMantener);
            document.getElementById('no_serie').focus();
            console.log("âœ… Formulario listo para siguiente producto");
        }, 300);
    }
    
    // Configurar el envÃ­o del formulario para incluir campos mantenidos
    document.getElementById('entradaForm').addEventListener('submit', function() {
        const camposMantenidos = Array.from(mantenerCamposSystem.camposAMantener);
        document.getElementById('campos_mantenidos').value = camposMantenidos.join(',');
        console.log('ðŸ“¤ Enviando campos mantenidos al backend:', camposMantenidos);
    });
});

    </script>

</body>
</html>