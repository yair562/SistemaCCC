<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Venta de Productos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/venta.css') }}">
</head>
<body>
    <h1>Gesti√≥n de Venta</h1>

    <div class="toolbar">
        <div class="left">
            <div class="ls-badge">
                <img src="{{ url_for('static', filename='images/CCClogo.jpg') }}" alt="logo">
                <div>Inventario CCC</div>
            </div>
            <div class="back-links">
                <a href="{{ url_for('admin') }}">üè† Panel</a>
            </div>
        </div>
        <div class="right">
            <form id="searchForm" method="get" action="{{ url_for('venta') }}">
                <input id="searchInput" type="text" name="q" placeholder="Buscar por SKU, marca, modelo o escanear" value="{{ q if q is defined else '' }}">
                <button type="submit">üîé Buscar</button>
                <!-- Controles del scanner del servidor -->
                <button id="startServerScan" type="button">Iniciar scanner (servidor)</button>
                <button id="stopServerScan" type="button">Detener scanner</button>
                <span id="scannerStatus">Inactivo</span>
            </form>
        </div>
    </div>

    <section class="section section-top">
        <h2>Buscar equipos para cambiar a VENTA</h2>
        <div class="table-wrap">
            <table class="productos">
                <tr>
                    <th>ID</th>
                    <th>SKU</th>
                    <th>Tipo</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>No. Serie</th>
                    <th>Precio Actual</th>
                    <th>Acci√≥n</th>
                </tr>
                <tbody id="searchResultsBody">
                {% if search_results %}
                    <tr>
                        <td colspan="8" style="background:#f9fafb">
                            <form id="bulkVentaForm" method="post" action="{{ url_for('venta_update_status') }}" onsubmit="return prepareBulkVenta(event)" style="display:flex; gap:10px; align-items:center;">
                                <input type="hidden" name="scope" value="selected">
                                <input type="hidden" id="bulkRowids" name="rowids" value="">
                                <input class="small-input-wide" type="text" name="precio" placeholder="Precio para seleccionados (opcional)">
                                <button type="submit">Poner a VENTA (seleccionados)</button>
                                <span id="bulkCounter" style="color:#555; font-size:12px;">0 seleccionados</span>
                            </form>
                        </td>
                    </tr>
                    {% for p in search_results %}
                    <tr>
                        <td>
                            <input type="checkbox" class="bulk-select" value="{{ p[0] }}" onchange="updateBulkCounter()">
                            {{ p[0] }}
                        </td>
                        <td>{{ p[1] }}</td>
                        <td>{{ p[3] }}</td>
                        <td>{{ p[4] }}</td>
                        <td>{{ p[5] }}</td>
                        <td>{{ p[6] }}</td>
                        <td>{{ p[8] if p[8] else 'Sin precio' }}</td>
                        <td>
                            <form method="post" action="{{ url_for('venta_update_status') }}" class="inline-form">
                                <input type="hidden" name="rowid" value="{{ p[0] }}">
                                <input class="small-input" type="text" name="precio" placeholder="Precio (opcional)" value="{{ p[8] if p[8] }}">
                                <div class="radio-row">
                                    <label class="label-inline">
                                        <input type="radio" name="scope" value="single" checked> Solo este
                                    </label>
                                    <label class="label-inline">
                                        <input type="radio" name="scope" value="category"> Toda la categor√≠a
                                    </label>
                                </div>
                                <button class="btn-primary" type="submit" onclick="return confirmBulkVenta(event, this)">Poner a VENTA</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="8" class="empty-row">Escribe o escanea para buscar en el inventario y poner equipos en VENTA.</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- Secci√≥n de listado de equipos en VENTA removida por solicitud: 
         mantener solo buscador y acci√≥n para poner a VENTA desde resultados. -->

    <script>
        function confirmBulkVenta(e, btn) {
            // Si el usuario seleccion√≥ 'category' preguntar confirmaci√≥n
            const form = btn.closest('form');
            if(!form) return true;
            const scope = Array.from(form.querySelectorAll('input[name="scope"]')).find(r=>r.checked);
            if(scope && scope.value === 'category'){
                const ok = confirm('¬øDeseas poner en estado VENTA a TODOS los productos de esta categor√≠a?');
                if(!ok){
                    e.preventDefault();
                    return false;
                }
            }
            return true;
        }

        function confirmBulkPrice(e, btn){
            // Si el usuario seleccion√≥ 'category' preguntar confirmaci√≥n
            const form = btn.closest('form');
            if(!form) return true;
            const scope = Array.from(form.querySelectorAll('input[name="scope"]')).find(r=>r.checked);
            if(scope && scope.value === 'category'){
                const ok = confirm('¬øDeseas aplicar el nuevo precio a TODOS los productos de esta categor√≠a?');
                if(!ok){
                    e.preventDefault();
                    return false;
                }
            }
            return true;
        }

        // ------------------ Integraci√≥n con scanner del servidor ------------------
        const startBtn = document.getElementById('startServerScan');
        const stopBtn = document.getElementById('stopServerScan');
        const scannerStatus = document.getElementById('scannerStatus');
        let serverScanning = false;
        let pollInterval = null;

        async function startServerScanner(){
            try{
                const r = await fetch('/start_scanner');
                const j = await r.json();
                if(r.ok && j.ok){
                    serverScanning = true;
                    scannerStatus.textContent = 'Activo ‚Äî ' + (j.msg || 'escaneando');
                    scannerStatus.style.color = 'green';
                    startPolling();
                } else {
                    scannerStatus.textContent = 'Error: ' + (j.msg || r.status);
                    scannerStatus.style.color = 'crimson';
                }
            }catch(e){
                scannerStatus.textContent = 'Error: ' + e.message;
                scannerStatus.style.color = 'crimson';
            }
        }

        async function stopServerScanner(){
            try{
                const r = await fetch('/stop_scanner');
                const j = await r.json();
                serverScanning = false;
                scannerStatus.textContent = (j && j.msg) ? j.msg : 'Detenido';
                scannerStatus.style.color = '#333';
                stopPolling();
            }catch(e){
                scannerStatus.textContent = 'Error: ' + e.message;
                scannerStatus.style.color = 'crimson';
            }
        }

        function startPolling(){
            if(pollInterval) return;
            pollInterval = setInterval(async ()=>{
                if(!serverScanning) return;
                try{
                    const r = await fetch('/last_scanned');
                    if(!r.ok) return;
                    const j = await r.json();
                    if(j && j.code){
                        // evitar m√∫ltiples redirecciones
                        serverScanning = false;
                        stopPolling();
                        // redirigir a la b√∫squeda por n√∫mero de serie
                        const code = encodeURIComponent(j.code);
                        window.location.href = '/venta?q=' + code + '&search_field=no_serie';
                    }
                }catch(e){
                    // ignore transient errors
                }
            }, 700);
        }

        function stopPolling(){
            if(pollInterval){
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        if(startBtn) startBtn.addEventListener('click', startServerScanner);
        if(stopBtn) stopBtn.addEventListener('click', stopServerScanner);

        // ------------------ Selecci√≥n m√∫ltiple para VENTA ------------------
        function getSelectedRowids(){
            return Array.from(document.querySelectorAll('.bulk-select:checked')).map(el=>el.value);
        }
        function updateBulkCounter(){
            const count = getSelectedRowids().length;
            const counter = document.getElementById('bulkCounter');
            if(counter){ counter.textContent = count + ' seleccionados'; }
        }
        function prepareBulkVenta(e){
            const ids = getSelectedRowids();
            if(ids.length === 0){
                alert('Selecciona al menos un producto.');
                e.preventDefault();
                return false;
            }
            const input = document.getElementById('bulkRowids');
            if(input){ input.value = ids.join(','); }
            return true;
        }
    </script>
</body>
</html>