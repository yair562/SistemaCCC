<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Productos {{ categoria }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/productos_list.css') }}">
</head>
<body>
    <h1>Productos en {{ categoria }}</h1>

    <div class="toolbar">
        <div class="left">
            <div class="ls-badge">
                <img src="{{ url_for('static', filename='images/CCClogo.jpg') }}" alt="logo">
                <div>Inventario CCC</div>
            </div>
            <div class="back-links">
                <a href="{{ url_for('admin') }}">üè† Panel</a>
                <a href="{{ url_for('categorias_list') }}">üìÇ Categor√≠as</a>
            </div>
        </div>
        <div class="right">
            <form id="searchForm" method="get"
        {% if prefijo is defined and prefijo %}
            action="{{ url_for('productos_por_categoria', prefijo=prefijo) }}"
        {% else %}
            action="{{ url_for('productos_all') }}"
        {% endif %}
            >
                <input id="searchInput" type="text" name="q" placeholder="Buscar por SKU, marca o modelo" value="{{ q if q is defined else '' }}">
                <button type="submit">üîé</button>
                {% if prefijo is defined and prefijo %}
                    <a href="{{ url_for('exportar_categoria_excel', prefijo=prefijo, q=q) }}" class="btn-export" style="margin-left:6px;">üì• Descargar Excel</a>
                    <a href="{{ url_for('productos_all') }}">Ver todos</a>
                {% endif %}
                <!-- Controles del scanner del servidor (el scanner local y la simulaci√≥n han sido removidos) -->
                <!-- Controles del scanner del servidor -->
                <button id="startServerScan" type="button">Iniciar scanner (servidor)</button>
                <button id="stopServerScan" type="button">Detener scanner</button>
                <span id="scannerStatus">Inactivo</span>
            </form>
        </div>
    </div>

    <div class="table-wrap">
    <table class="productos">
    <tr>
        <th>ID</th>
        <th>SKU</th>
        <th>ID Original</th>
        <th>Tipo</th>
        <th>Marca</th>
        <th>Modelo</th>
        <th>No. Serie</th>
        <th>Volts</th>
        <th>Precio</th>
        <th>Estado</th>
        <th>Ubicaci√≥n</th>
        <th>Fecha registro</th>
        <th>Observaci√≥n</th>
        <th>Acciones</th>
    </tr>

    {% if productos %}
        {% for p in productos %}
        <tr>
            <td>{{ p[0] }}</td>
            <td>{{ p[1] }}</td>
            <td>{{ p[2] }}</td>
            <td>{{ p[3] }}</td>
            <td>{{ p[4] }}</td>
            <td>{{ p[5] }}</td>
            <td>{{ p[6] }}</td>
            <td>{{ p[7] }}</td>
            <td>{{ p[8] }}</td>
            <td>{{ p[9] }}</td>
            <td>{{ p[10] }}</td>
            <td>{{ p[11] }}</td>
            <td>{{ p[13] }}</td>
            <td>
                <form method="get" action="{{ url_for('request_edit', rowid=p[0]) }}" style="display:inline">
                    <button type="submit">Editar</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    {% else %}
        <tr><td colspan="14">No se encontraron productos.</td></tr>
    {% endif %}
    </table>
    </div>

    <script>
        // Base del servidor (se toma de request.host_url en Flask; sin barra final)
        const SERVER = "{{ request.host_url[:-1] }}";

        // Nota: el input local de escaneo y la simulaci√≥n fueron removidos del HTML.

        // ------------------ Integraci√≥n con scanner del servidor ------------------
        const startBtn = document.getElementById('startServerScan');
        const stopBtn = document.getElementById('stopServerScan');
        const scannerStatus = document.getElementById('scannerStatus');
        let serverScanning = false;
        let pollInterval = null;

        async function startServerScanner(){
            try{
                const r = await fetch(`${SERVER}/start_scanner`);
                const j = await r.json().catch(()=>({ok:false,msg:'invalid json'}));
                if(r.ok && j.ok){
                    serverScanning = true;
                    scannerStatus.textContent = 'Activo ‚Äî ' + (j.msg || 'escaneando');
                    scannerStatus.style.color = 'green';
                    startPolling();
                } else {
                    scannerStatus.textContent = 'Error: ' + (j.msg || r.status);
                    scannerStatus.style.color = 'crimson';
                }
            }catch(e){
                scannerStatus.textContent = 'Error: ' + e.message;
                scannerStatus.style.color = 'crimson';
            }
        }

        async function stopServerScanner(){
            try{
                const r = await fetch(`${SERVER}/stop_scanner`);
                const j = await r.json().catch(()=>({msg:'invalid json'}));
                serverScanning = false;
                scannerStatus.textContent = (j && j.msg) ? j.msg : 'Detenido';
                scannerStatus.style.color = '#333';
                stopPolling();
            }catch(e){
                scannerStatus.textContent = 'Error: ' + e.message;
                scannerStatus.style.color = 'crimson';
            }
        }

        function startPolling(){
            if(pollInterval) return;
            pollInterval = setInterval(async ()=>{
                if(!serverScanning) return;
                try{
                    const r = await fetch(`${SERVER}/last_scanned`);
                    if(!r.ok) return;
                    const j = await r.json().catch(()=>null);
                    if(j && j.code){
                        // evitar m√∫ltiples redirecciones
                        serverScanning = false;
                        stopPolling();
                        // redirigir a la b√∫squeda por n√∫mero de serie en el servidor
                        const code = encodeURIComponent(j.code);
                        window.location.href = `${SERVER}/productos?q=` + code + '&search_field=no_serie';
                    }
                }catch(e){
                    // ignore transient errors
                }
            }, 700);
        }

        function stopPolling(){
            if(pollInterval){
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        if(startBtn) startBtn.addEventListener('click', startServerScanner);
        if(stopBtn) stopBtn.addEventListener('click', stopServerScanner);

        // Nota: la funcionalidad de simulaci√≥n local fue removida del HTML.
    </script>
</body>
</html>
